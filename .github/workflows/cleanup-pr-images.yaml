---
name: Cleanup PR Images

on:
  workflow_dispatch:

permissions:
  packages: write

jobs:
  cleanup:
    name: Cleanup PR Images
    runs-on: ubuntu-latest
    steps:
      - name: Delete pr-* container images
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          OWNER="${{ github.repository_owner }}"
          PACKAGE="${{ github.event.repository.name }}"

          echo "ğŸ” Fetching container versions with pr-* tags..."

          gh api --paginate "/users/${OWNER}/packages/container/${PACKAGE}/versions" \
            --jq '.[] | select(.metadata.container.tags[]? | startswith("pr-")) | {id: .id, tags: .metadata.container.tags}' \
            > /tmp/versions.json

          if [ ! -s /tmp/versions.json ]; then
            echo "âœ… No pr-* images found"
            exit 0
          fi

          echo "ğŸ—‘ï¸  Deleting versions..."
          jq -r '.id' /tmp/versions.json | while read -r version_id; do
            echo "  Deleting version ID: ${version_id}"
            if gh api --method DELETE --silent "/users/${OWNER}/packages/container/${PACKAGE}/versions/${version_id}"; then
              echo "  âœ… Deleted ${version_id}"
            else
              echo "  âŒ Failed to delete ${version_id}"
            fi
          done

          echo "âœ… Cleanup complete"
